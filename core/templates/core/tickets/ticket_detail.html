{% extends 'base.html' %}
{% load static %}

{% block title %}Ticket {{ object.numero }} - Sistema de Servicio Técnico{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="bi bi-ticket-detailed"></i> Ticket {{ object.numero }}
            </h1>
            <div class="btn-group">
                <a href="{% url 'ticket_edit' object.pk %}" class="btn btn-warning">
                    <i class="bi bi-pencil"></i> Editar
                </a>
                <a href="{% url 'ticket_delete' object.pk %}" class="btn btn-danger">
                    <i class="bi bi-trash"></i> Eliminar
                </a>
                <a href="{% url 'ticket_list' %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Volver
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Información del Ticket -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-info-circle"></i> Información del Ticket
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>Número:</strong></td>
                                <td>{{ object.numero }}</td>
                            </tr>
                            <tr>
                                <td><strong>Cliente:</strong></td>
                                <td>
                                    <a href="{% url 'cliente_detail' object.equipo.cliente.pk %}" class="text-decoration-none">
                                        {{ object.equipo.cliente.nombre }}
                                    </a>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Equipo:</strong></td>
                                <td>
                                    <a href="{% url 'equipo_detail' object.equipo.pk %}" class="text-decoration-none">
                                        {{ object.equipo.marca }} {{ object.equipo.modelo }}
                                    </a>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Número de Serie:</strong></td>
                                <td>{{ object.equipo.numero_serie }}</td>
                            </tr>
                            <tr>
                                <td><strong>Estado:</strong></td>
                                <td>
                                    <span class="badge bg-{% if object.estado == 'completado' %}success{% elif object.estado == 'entregado' %}info{% elif object.estado == 'cancelado' %}danger{% else %}warning{% endif %}">
                                        {{ object.get_estado_display }}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Prioridad:</strong></td>
                                <td>
                                    <span class="badge bg-{% if object.prioridad == 'alta' %}danger{% elif object.prioridad == 'media' %}warning{% else %}success{% endif %}">
                                        {{ object.get_prioridad_display }}
                                    </span>
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>Fecha de Ingreso:</strong></td>
                                <td>{{ object.fecha_ingreso|date:"d/m/Y H:i" }}</td>
                            </tr>
                            <tr>
                                <td><strong>Fecha Prometida:</strong></td>
                                <td>{{ object.fecha_prometida|date:"d/m/Y H:i"|default:"-" }}</td>
                            </tr>
                            <tr>
                                <td><strong>Técnico Asignado:</strong></td>
                                <td>{{ object.tecnico_asignado|default:"Sin asignar" }}</td>
                            </tr>
                            <tr>
                                <td><strong>Costo Estimado:</strong></td>
                                <td>${{ object.costo_estimado|floatformat:2 }}</td>
                            </tr>
                            <tr>
                                <td><strong>Costo Real:</strong></td>
                                <td>${{ object.costo_real|floatformat:2 }}</td>
                            </tr>
                            <tr>
                                <td><strong>Diferencia:</strong></td>
                                <td>
                                    {% if object.costo_real > object.costo_estimado %}
                                        <span class="text-danger">+${{ object.costo_real|sub:object.costo_estimado|floatformat:2 }}</span>
                                    {% elif object.costo_real < object.costo_estimado %}
                                        <span class="text-success">-${{ object.costo_estimado|sub:object.costo_real|floatformat:2 }}</span>
                                    {% else %}
                                        <span class="text-muted">$0.00</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h6>Problema Reportado:</h6>
                    <div class="card bg-light">
                        <div class="card-body">
                            <p class="mb-0">{{ object.problema_reportado }}</p>
                        </div>
                    </div>
                </div>
                
                {% if object.observaciones %}
                <div class="mt-3">
                    <h6>Observaciones:</h6>
                    <div class="card bg-light">
                        <div class="card-body">
                            <p class="mb-0">{{ object.observaciones }}</p>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Acciones Rápidas -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-lightning"></i> Acciones Rápidas
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if object.estado != 'completado' %}
                        <button class="btn btn-success" onclick="cambiarEstado('completado')">
                            <i class="bi bi-check-circle"></i> Marcar como Completado
                        </button>
                    {% endif %}
                    
                    {% if object.estado != 'entregado' and object.estado == 'completado' %}
                        <button class="btn btn-info" onclick="cambiarEstado('entregado')">
                            <i class="bi bi-box-arrow-right"></i> Marcar como Entregado
                        </button>
                    {% endif %}
                    
                    {% if object.estado not in 'cancelado,entregado' %}
                        <button class="btn btn-danger" onclick="cambiarEstado('cancelado')">
                            <i class="bi bi-x-circle"></i> Cancelar Ticket
                        </button>
                    {% endif %}
                    
                    <a href="{% url 'factura_create' %}?ticket={{ object.pk }}" class="btn btn-warning">
                        <i class="bi bi-receipt"></i> Crear Factura
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Historial de Estados -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-clock-history"></i> Historial
                </h5>
            </div>
            <div class="card-body">
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-marker bg-primary"></div>
                        <div class="timeline-content">
                            <h6 class="timeline-title">Ticket Creado</h6>
                            <p class="timeline-text">{{ object.fecha_ingreso|date:"d/m/Y H:i" }}</p>
                        </div>
                    </div>
                    
                    {% if object.fecha_prometida %}
                    <div class="timeline-item">
                        <div class="timeline-marker bg-warning"></div>
                        <div class="timeline-content">
                            <h6 class="timeline-title">Fecha Prometida</h6>
                            <p class="timeline-text">{{ object.fecha_prometida|date:"d/m/Y H:i" }}</p>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="timeline-item">
                        <div class="timeline-marker bg-{% if object.estado == 'completado' %}success{% elif object.estado == 'cancelado' %}danger{% else %}warning{% endif %}"></div>
                        <div class="timeline-content">
                            <h6 class="timeline-title">Estado Actual</h6>
                            <p class="timeline-text">{{ object.get_estado_display }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Garantías -->
{% if garantias %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-shield-check"></i> Garantías ({{ garantias.count }})
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Tipo</th>
                                <th>Fecha Inicio</th>
                                <th>Fecha Fin</th>
                                <th>Duración</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for garantia in garantias %}
                            <tr>
                                <td>{{ garantia.get_tipo_display }}</td>
                                <td>{{ garantia.fecha_inicio|date:"d/m/Y" }}</td>
                                <td>{{ garantia.fecha_fin|date:"d/m/Y" }}</td>
                                <td>{{ garantia.duracion_meses }} meses</td>
                                <td>
                                    {% if garantia.activa %}
                                        <span class="badge bg-success">Activa</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Inactiva</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Gastos -->
{% if gastos %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-currency-dollar"></i> Gastos ({{ gastos.count }})
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Descripción</th>
                                <th>Categoría</th>
                                <th>Monto</th>
                                <th>Fecha</th>
                                <th>Comprobante</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for gasto in gastos %}
                            <tr>
                                <td>{{ gasto.descripcion }}</td>
                                <td>
                                    <span class="badge bg-info">{{ gasto.get_categoria_display }}</span>
                                </td>
                                <td>${{ gasto.monto|floatformat:2 }}</td>
                                <td>{{ gasto.fecha|date:"d/m/Y" }}</td>
                                <td>
                                    {% if gasto.comprobante %}
                                        <a href="{{ gasto.comprobante.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-file-earmark"></i> Ver
                                        </a>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
function cambiarEstado(nuevoEstado) {
    if (confirm('¿Estás seguro de cambiar el estado del ticket?')) {
        // Aquí se implementaría la lógica para cambiar el estado
        // Por ahora, redirigimos a la página de edición
        window.location.href = "{% url 'ticket_edit' object.pk %}";
    }
}
</script>

<style>
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: -35px;
    top: 5px;
    width: 10px;
    height: 10px;
    border-radius: 50%;
}

.timeline-content {
    padding-left: 15px;
}

.timeline-title {
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 5px;
}

.timeline-text {
    font-size: 0.8rem;
    color: #6c757d;
    margin-bottom: 0;
}
</style>
{% endblock %}
